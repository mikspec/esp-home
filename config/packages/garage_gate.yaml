# Garage Gate Package
# This package contains all automations, scripts, and helpers for the garage gate
# To use: Add this to your configuration.yaml:
#   homeassistant:
#     packages:
#       garage_gate: !include packages/garage_gate.yaml

# ----------------------------------------------
# Template Sensors
# ----------------------------------------------
template:
  - binary_sensor:
      - name: "Garage Open Too Long"
        unique_id: garage_open_too_long
        device_class: problem
        state: >
          {{ is_state('cover.garage_gate_garage_gate', 'open') and
             (as_timestamp(now()) - as_timestamp(states.cover.garage_gate_garage_gate.last_changed)) > 600 }}

  - sensor:
      - name: "Garage Door Open Duration"
        unique_id: garage_door_open_duration
        unit_of_measurement: "minutes"
        state: >
          {% if is_state('cover.garage_gate_garage_gate', 'open') %}
            {{ ((as_timestamp(now()) - as_timestamp(states.cover.garage_gate_garage_gate.last_changed)) / 60) | round(0) }}
          {% else %}
            0
          {% endif %}

# ----------------------------------------------
# Input Booleans
# ----------------------------------------------
input_boolean:
  garage_auto_close_enabled:
    name: "Enable Auto-Close Garage"
    icon: mdi:garage-variant

  garage_notifications_enabled:
    name: "Enable Garage Notifications"
    icon: mdi:bell

# ----------------------------------------------
# Automations
# ----------------------------------------------
automation:
  # Auto-close garage if left open for 10 minutes
  - id: garage_auto_close
    alias: "Garage: Auto-close if left open"
    description: "Automatically close garage door if left open for 10 minutes"
    trigger:
      - platform: state
        entity_id: cover.garage_gate_garage_gate
        to: "open"
        for:
          minutes: 10
    condition:
      # Only auto-close during certain hours (optional)
      - condition: time
        after: "22:00:00"
        before: "06:00:00"
    action:
      - service: cover.close_cover
        target:
          entity_id: cover.garage_gate_garage_gate
      - service: notify.mobile_app_your_phone
        data:
          message: "Garage door was left open and has been automatically closed"
          title: "Garage Auto-Closed"

  # Notification when garage opens
  - id: garage_opened_notification
    alias: "Garage: Notify when opened"
    description: "Send notification when garage door opens"
    trigger:
      - platform: state
        entity_id: cover.garage_gate_garage_gate
        to: "open"
    action:
      - service: notify.mobile_app_your_phone
        data:
          message: "Garage door has been opened"
          title: "Garage Opened"
          data:
            # Android specific - show action buttons
            actions:
              - action: "CLOSE_GARAGE"
                title: "Close Now"
            # iOS specific - critical alert
            push:
              interruption-level: time-sensitive

  # Notification when garage closes
  - id: garage_closed_notification
    alias: "Garage: Notify when closed"
    description: "Send notification when garage door closes"
    trigger:
      - platform: state
        entity_id: cover.garage_gate_garage_gate
        to: "closed"
    action:
      - service: notify.mobile_app_your_phone
        data:
          message: "Garage door has been closed"
          title: "Garage Closed"

  # Handle notification action - close garage
  - id: garage_notification_action_close
    alias: "Garage: Handle notification action"
    description: "Close garage when notification action is pressed"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: CLOSE_GARAGE
    action:
      - service: cover.close_cover
        target:
          entity_id: cover.garage_gate_garage_gate

  # Alert if garage left open when leaving home
  - id: garage_open_leaving_home
    alias: "Garage: Alert when leaving with door open"
    description: "Alert if garage is open when everyone leaves"
    trigger:
      - platform: state
        entity_id: group.all_persons
        to: "not_home"
    condition:
      - condition: state
        entity_id: cover.garage_gate_garage_gate
        state: "open"
    action:
      - service: notify.mobile_app_your_phone
        data:
          message: "Warning: You left home with the garage door open!"
          title: "Garage Door Open"
          data:
            actions:
              - action: "CLOSE_GARAGE"
                title: "Close Now"
            # Make notification persistent
            tag: "garage-open-alert"
            # Android: Critical notification
            channel: alarm_stream
            importance: high

  # Auto-open garage when arriving home (geofence)
  - id: garage_auto_open_arriving
    alias: "Garage: Auto-open when arriving home"
    description: "Open garage door when arriving home (optional - be careful!)"
    trigger:
      - platform: state
        entity_id: person.your_name
        to: "home"
    condition:
      # Only if garage is closed
      - condition: state
        entity_id: cover.garage_gate_garage_gate
        state: "closed"
      # Only during certain hours
      - condition: time
        after: "06:00:00"
        before: "23:00:00"
    action:
      # Optional: Send notification first
      - service: notify.mobile_app_your_phone
        data:
          message: "Opening garage door..."
          title: "Welcome Home"
      - delay:
          seconds: 2
      - service: cover.open_cover
        target:
          entity_id: cover.garage_gate_garage_gate

  # Daily reminder if garage is open
  - id: garage_daily_status_check
    alias: "Garage: Daily status reminder"
    description: "Send daily reminder at bedtime if garage is open"
    trigger:
      - platform: time
        at: "22:00:00"
    condition:
      - condition: state
        entity_id: cover.garage_gate_garage_gate
        state: "open"
    action:
      - service: notify.mobile_app_your_phone
        data:
          message: "Reminder: The garage door is still open"
          title: "Garage Status Check"
          data:
            actions:
              - action: "CLOSE_GARAGE"
                title: "Close It"

  # Blink lights when garage opens (visual indicator)
  - id: garage_visual_indicator
    alias: "Garage: Blink lights when opened"
    description: "Flash garage lights 3 times when door opens"
    trigger:
      - platform: state
        entity_id: cover.garage_gate_garage_gate
        to: "open"
    action:
      - repeat:
          count: 3
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.garage_light
            - delay:
                milliseconds: 500
            - service: light.turn_off
              target:
                entity_id: light.garage_light
            - delay:
                milliseconds: 500

  # Log garage activity to file
  - id: garage_activity_logger
    alias: "Garage: Log all activity"
    description: "Log garage door state changes"
    trigger:
      - platform: state
        entity_id: cover.garage_gate_garage_gate
    action:
      - service: notify.persistent_notification
        data:
          message: >
            Garage door {{ trigger.to_state.state }} at 
            {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
          title: "Garage Activity Log"

  # Weekly WiFi signal check
  - id: garage_wifi_check
    alias: "Garage: Weekly WiFi signal check"
    description: "Alert if WiFi signal is poor"
    trigger:
      - platform: time
        at: "12:00:00"
    condition:
      - condition: time
        weekday:
          - sun
      - condition: numeric_state
        entity_id: sensor.garage_gate_garage_gate_wifi_signal
        below: -75
    action:
      - service: notify.mobile_app_your_phone
        data:
          message: >
            Garage controller WiFi signal is weak: 
            {{ states('sensor.garage_gate_garage_gate_wifi_signal') }} dBm
          title: "Garage WiFi Alert"

  # Sync HA helper with ESPHome auto-close switch
  - id: garage_sync_auto_close_to_esphome
    alias: "Garage: Sync auto-close helper to ESPHome"
    trigger:
      - platform: state
        entity_id: input_boolean.garage_auto_close_enabled
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.garage_auto_close_enabled
                state: "on"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.garage_gate_garage_gate_auto_close
          - conditions:
              - condition: state
                entity_id: input_boolean.garage_auto_close_enabled
                state: "off"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: switch.garage_gate_garage_gate_auto_close

# ----------------------------------------------
# Scripts
# ----------------------------------------------
script:
  # Close garage with confirmation
  close_garage_with_confirm:
    alias: "Close Garage (with confirm)"
    sequence:
      - service: notify.mobile_app_your_phone
        data:
          message: "Closing garage door in 5 seconds..."
          title: "Garage Closing"
      - delay:
          seconds: 5
      - service: cover.close_cover
        target:
          entity_id: cover.garage_gate_garage_gate
      - delay:
          seconds: 2
      - service: notify.mobile_app_your_phone
        data:
          message: "Garage door closed"
          title: "Garage Closed"

  # Toggle garage (smart) using cover
  garage_smart_toggle:
    alias: "Garage Smart Toggle"
    sequence:
      - choose:
          - conditions:
              - condition: state
                entity_id: cover.garage_gate_garage_gate
                state: "open"
            sequence:
              - service: cover.close_cover
                target:
                  entity_id: cover.garage_gate_garage_gate
          - conditions:
              - condition: state
                entity_id: cover.garage_gate_garage_gate
                state: "closed"
            sequence:
              - service: cover.open_cover
                target:
                  entity_id: cover.garage_gate_garage_gate

  # Trigger via ESPHome gate_action (anti-replay safe)
  garage_gate_action_open:
    alias: "Garage Gate Action Open"
    sequence:
      - service: esphome.garage_gate_gate_action
        data:
          request_id: "{{ (now().timestamp() * 1000) | int }}"
          action: "open"

  garage_gate_action_close:
    alias: "Garage Gate Action Close"
    sequence:
      - service: esphome.garage_gate_gate_action
        data:
          request_id: "{{ (now().timestamp() * 1000) | int }}"
          action: "close"
