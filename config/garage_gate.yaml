esphome:
  name: garage-gate
  friendly_name: garage-gate
  on_boot:
    priority: -100
    then:
      - lambda: |-
          if (id(gate_contactron).state) {
            id(open_gate_timestamp_ms) = millis();
            // Note: auto-close period not set on boot, only when opened from button
          }

esp8266:
  board: nodemcuv2

# WiFi configuration - use secrets for credentials
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Enable fallback hotspot in case wifi connection fails
  ap:
    ssid: "Garage Gate Fallback"
    password: !secret fallback_password

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key
  services:
    - service: gate_action
      variables:
        request_id: int
        action: string
      then:
        - lambda: |-
            const int64_t req_timestamp = static_cast<int64_t>(request_id);
            
            if (req_timestamp <= 0) {
              ESP_LOGW("gate", "Invalid request_id - ignoring");
              return;
            }
            
            // Reject if request_id is not higher than last processed
            if (req_timestamp <= id(last_request_timestamp)) {
              ESP_LOGW("gate", "Rejected: request_id %lld <= last_timestamp %lld (replay or old request)", 
                       req_timestamp, id(last_request_timestamp));
              return;
            }
            
            // Accept and update last timestamp
            id(last_request_timestamp) = req_timestamp;
            ESP_LOGI("gate", "Processing request_id %lld", req_timestamp);
            
            if (action == "open") {
              if (!id(gate_contactron).state) {
                id(last_action_source) = 1;
                id(gate_action_script).execute();
              }
              return;
            }
            if (action == "close") {
              if (id(gate_contactron).state) {
                id(last_action_source) = 1;
                id(gate_action_script).execute();
              }
              return;
            }
            if (action == "stop" || action == "toggle") {
              id(last_action_source) = 1;
              id(gate_action_script).execute();
              return;
            }
            ESP_LOGW("gate", "Unknown action '%s'", action.c_str());

# Enable Over-The-Air updates
ota:
  - platform: esphome
    password: !secret ota_password

# Web server for standalone access (optional)
#web_server:
#  port: 80

# Status LED (optional - uses built-in LED on NodeMCU)
# GPIO2 (D4) is the built-in LED on NodeMCU boards
status_led:
  pin:
    number: GPIO2
    inverted: true

globals:
  - id: button_pressed
    type: bool
    restore_value: false
    initial_value: "false"
  - id: button_press_start_ms
    type: uint32_t
    restore_value: false
    initial_value: "0"
  - id: action1_triggered
    type: bool
    restore_value: false
    initial_value: "false"
  - id: action2_triggered
    type: bool
    restore_value: false
    initial_value: "false"
  - id: open_gate_timestamp_ms
    type: uint32_t
    restore_value: false
    initial_value: "0"
  - id: open_gate_period_ms
    type: uint32_t
    restore_value: false
    initial_value: "0"
  - id: last_request_timestamp
    type: int64_t
    restore_value: false
    initial_value: "0"
  - id: last_action_source
    type: int
    restore_value: false
    initial_value: "0"

script:
  - id: gate_relay_pulse
    mode: single
    then:
      - if:
          condition:
            switch.is_on: gate_enabled
          then:
            - switch.turn_on: gate_relay
            - delay: !lambda "return id(relay_pulse_duration).state;"
            - switch.turn_off: gate_relay
          else:
            - logger.log: "Gate relay suppressed (gate disabled)"
  - id: gate_action_script
    mode: single
    then:
      - lambda: |-
          if (!id(gate_enabled).state) {
            ESP_LOGW("gate", "Gate disabled - ignoring action");
            return;
          }
          if (id(gate_contactron).state) {  // if currently open, we're closing
            id(open_gate_period_ms) = 0;
          }
      - script.execute: gate_relay_pulse

interval:
  - interval: 50ms
    then:
      - lambda: |-
          const uint32_t now = millis();

          if (id(button_pressed)) {
            const uint32_t press_ms = now - id(button_press_start_ms);
            if (!id(action1_triggered) && press_ms > id(button_delay_action1).state) {
              id(action1_triggered) = true;
              ESP_LOGI("gate", "Button action 1 - relay pulse");
              id(last_action_source) = 0;
              id(gate_action_script).execute();
            }
            if (!id(action2_triggered) && press_ms > id(button_delay_action2).state) {
              id(action2_triggered) = true;
              if (id(open_gate_period_ms) > 0) {
                id(open_gate_period_ms) = id(gate_open_period_short).state;
                ESP_LOGI("gate", "Button action 2 - short open period");
              }
            }
          }

          if (id(open_gate_period_ms) > 0 && id(open_gate_timestamp_ms) > 0 &&
              (now - id(open_gate_timestamp_ms)) > id(open_gate_period_ms)) {
            id(open_gate_period_ms) = 0;
            ESP_LOGI("gate", "Auto-close timeout reached - relay pulse");
            id(gate_relay_pulse).execute();
          }

# Binary sensor for the contactron (gate position sensor)
# Assumes contactron is connected to GPIO14 (D5 on NodeMCU)
# When gate is closed, contactron is closed (LOW), when open it's open (HIGH)
binary_sensor:
  - platform: gpio
    id: gate_contactron
    name: "Garage Gate Position Sensor"
    pin:
      number: GPIO14  # D5
      mode:
        input: true
        pullup: true
      inverted: false
    device_class: garage_door
    filters:
      - delayed_on: 100ms
      - delayed_off: 100ms
    on_press:
      then:
        - logger.log: "Gate is OPEN"
        - lambda: |-
            id(open_gate_timestamp_ms) = millis();
            if (id(auto_close_enabled).state && id(open_gate_period_ms) == 0 && id(last_action_source) == 0) {
              id(open_gate_period_ms) = id(gate_open_period_normal).state;
            }
    on_release:
      then:
        - logger.log: "Gate is CLOSED"
        - lambda: |-
            id(open_gate_timestamp_ms) = 0;
            id(open_gate_period_ms) = 0;

  # Physical button to control the gate
  # Assumes button is connected to GPIO4 (D2 on NodeMCU)
  - platform: gpio
    id: gate_button
    name: "Garage Gate Button"
    pin:
      number: GPIO4  # D2
      mode:
        input: true
        pullup: true
      inverted: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      then:
        - logger.log: "Button pressed"
        - lambda: |-
            id(button_pressed) = true;
            id(button_press_start_ms) = millis();
            id(action1_triggered) = false;
            id(action2_triggered) = false;
    on_release:
      then:
        - logger.log: "Button released"
        - lambda: |-
            id(button_pressed) = false;
            id(button_press_start_ms) = 0;
            id(action1_triggered) = false;
            id(action2_triggered) = false;

# Relay to control the garage gate
# Assumes relay is connected to GPIO5 (D1 on NodeMCU)
switch:
  - platform: template
    id: gate_enabled
    name: "Garage Gate Active"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
  - platform: template
    id: auto_close_enabled
    name: "Garage Gate Auto Close"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
  - platform: gpio
    id: gate_relay
    name: "Garage Gate Relay"
    pin:
      number: GPIO5  # D1
      inverted: true
    restore_mode: ALWAYS_OFF
    on_turn_on:
      - logger.log: "Gate relay activated"
    on_turn_off:
      - logger.log: "Gate relay deactivated"

# Cover component for better Home Assistant integration
# This presents the garage gate as a cover entity
cover:
  - platform: template
    name: "Garage Gate"
    device_class: garage
    lambda: |-
      if (id(gate_contactron).state) {
        return COVER_OPEN;
      } else {
        return COVER_CLOSED;
      }
    open_action:
      # Only trigger if gate is currently closed
      - if:
          condition:
            binary_sensor.is_off: gate_contactron
          then:
            - logger.log: "Opening garage gate"
            - lambda: id(last_action_source) = 1;
            - script.execute: gate_action_script
    close_action:
      # Only trigger if gate is currently open
      - if:
          condition:
            binary_sensor.is_on: gate_contactron
          then:
            - logger.log: "Closing garage gate"
            - lambda: id(last_action_source) = 1;
            - script.execute: gate_action_script
    stop_action:
      # Trigger relay to stop the gate
      - logger.log: "Stopping garage gate"
      - lambda: id(last_action_source) = 1;
      - script.execute: gate_action_script

# Configuration numbers - adjustable from Home Assistant
number:
  - platform: template
    id: relay_pulse_duration
    name: "Gate Relay Pulse Duration"
    optimistic: true
    min_value: 100
    max_value: 3000
    step: 100
    unit_of_measurement: "ms"
    mode: box
    restore_value: true
    initial_value: 1000
  - platform: template
    id: button_delay_action1
    name: "Button Press Delay Action 1"
    optimistic: true
    min_value: 100
    max_value: 2000
    step: 100
    unit_of_measurement: "ms"
    mode: box
    restore_value: true
    initial_value: 500
  - platform: template
    id: button_delay_action2
    name: "Button Press Delay Action 2"
    optimistic: true
    min_value: 1000
    max_value: 5000
    step: 100
    unit_of_measurement: "ms"
    mode: box
    restore_value: true
    initial_value: 2000
  - platform: template
    id: gate_open_period_normal
    name: "Gate Auto-Close Period Normal"
    optimistic: true
    min_value: 3000
    max_value: 300000
    step: 1000
    unit_of_measurement: "ms"
    mode: box
    restore_value: true
    initial_value: 120000
  - platform: template
    id: gate_open_period_short
    name: "Gate Auto-Close Period Short"
    optimistic: true
    min_value: 3000
    max_value: 300000
    step: 1000
    unit_of_measurement: "ms"
    mode: box
    restore_value: true
    initial_value: 30000

# Sensor to show WiFi signal strength
sensor:
  - platform: wifi_signal
    name: "Garage Gate WiFi Signal"
    update_interval: 60s

# Text sensor to show IP address and ESPHome version
text_sensor:
  - platform: wifi_info
    ip_address:
      name: "Garage Gate IP Address"
    ssid:
      name: "Garage Gate Connected SSID"
  - platform: version
    name: "Garage Gate ESPHome Version"
